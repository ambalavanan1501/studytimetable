import{j as e,r as s,q as t,a1 as a,i as l,N as c,k as n,l as r,a2 as d,X as i,a3 as o}from"./ui-vendor-yoAZ-FXJ.js";import{r as x}from"./react-vendor-DR97ylRc.js";import{u as m,c as u,s as h}from"./index-CNb4MtWx.js";import"./pdf-vendor-CnZj0n1s.js";import"./supabase-vendor-C9Ts7tiD.js";function j(){const{user:j}=m(),[f,p]=x.useState("mark"),[b,g]=x.useState(new Date),[N,_]=x.useState([]),[v,w]=x.useState([]),[y,k]=x.useState([]),S=e=>e.toISOString().split("T")[0],q=e=>e.toLocaleDateString("en-US",{weekday:"long"}),C=async()=>{if(j)try{if("mark"===f){const e=q(b),s=S(b),[t,a]=await Promise.all([h.from("timetable_entries").select("*").eq("user_id",j.id).eq("day",e),h.from("smart_timetable_entries").select("*").eq("user_id",j.id).eq("day",e)]),l=[...t.data||[],...a.data||[]];l.sort((e,s)=>e.start_time.localeCompare(s.start_time)),_(l);const{data:c}=await h.from("attendance_logs").select("subject_code, status").eq("user_id",j.id).eq("date",s);w(c||[])}else{const[e,s]=await Promise.all([h.from("timetable_entries").select("subject_name, subject_code").eq("user_id",j.id),h.from("smart_timetable_entries").select("subject_name, subject_code").eq("user_id",j.id)]),t=new Map;[...e.data||[],...s.data||[]].forEach(e=>{t.has(e.subject_code)||t.set(e.subject_code,e.subject_name)});const{data:a}=await h.from("attendance_logs").select("subject_code, status").eq("user_id",j.id),l=[];t.forEach((e,s)=>{const t=(null==a?void 0:a.filter(e=>e.subject_code===s))||[],c=t.filter(e=>"present"===e.status).length,n=t.filter(e=>"absent"===e.status).length,r=c+n;l.push({subject_name:e,subject_code:s,total_classes:r,present:c,absent:n,percentage:r>0?Math.round(c/r*100):0})}),k(l)}}catch(e){}};x.useEffect(()=>{C()},[b,j,f]);const D=async(e,s)=>{if(!j)return;const t=S(b);w(t=>[...t.filter(s=>s.subject_code!==e),{subject_code:e,status:s}]);try{const{error:a}=await h.from("attendance_logs").upsert({user_id:j.id,date:t,subject_code:e,status:s},{onConflict:"user_id, date, subject_code"});if(a)throw a}catch(a){C()}},A=e=>{const s=new Date(b);s.setDate(b.getDate()+e),g(s)};return e.jsxs("div",{className:"p-6 space-y-6 pb-24 staggered-fade-in",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-800 mt-4",children:"Attendance"}),e.jsxs("div",{className:"flex p-1 bg-slate-200/50 rounded-xl",children:[e.jsxs("button",{onClick:()=>p("mark"),className:u("flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg text-sm font-bold transition-all","mark"===f?"bg-white text-primary-600 shadow-sm":"text-slate-500 hover:text-slate-700"),children:[e.jsx(s,{className:"h-4 w-4"}),"Mark Attendance"]}),e.jsxs("button",{onClick:()=>p("stats"),className:u("flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg text-sm font-bold transition-all","stats"===f?"bg-white text-primary-600 shadow-sm":"text-slate-500 hover:text-slate-700"),children:[e.jsx(t,{className:"h-4 w-4"}),"Statistics"]})]}),"mark"===f?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"glass-card p-4 rounded-2xl flex items-center justify-between",children:[e.jsx("button",{onClick:()=>A(-1),className:"p-2 hover:bg-white/50 rounded-full transition-colors",children:e.jsx(a,{className:"h-5 w-5 text-slate-600"})}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-medium text-slate-500",children:q(b)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:"h-4 w-4 text-primary-600"}),e.jsx("span",{className:"text-lg font-bold text-slate-800",children:b.toLocaleDateString()})]})]}),e.jsx("button",{onClick:()=>A(1),className:"p-2 hover:bg-white/50 rounded-full transition-colors",children:e.jsx(c,{className:"h-5 w-5 text-slate-600"})})]}),e.jsx("div",{className:"space-y-4",children:0===N.length?e.jsx("div",{className:"text-center py-10 text-slate-400",children:e.jsx("p",{children:"No classes scheduled for this day."})}):N.map(s=>{const t=v.find(e=>e.subject_code===s.subject_code),a="present"===(null==t?void 0:t.status),l="absent"===(null==t?void 0:t.status);return e.jsxs("div",{className:"glass-card p-5 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-800 text-lg",children:s.subject_name}),e.jsx("p",{className:"text-sm text-slate-500 font-medium",children:s.subject_code})]}),e.jsx("span",{className:u("text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wide","theory"===s.type?"bg-primary-100 text-primary-600":"bg-pink-100 text-pink-600"),children:s.type})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-500 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(n,{className:"h-4 w-4 text-primary-400"}),e.jsxs("span",{className:"font-medium",children:[s.start_time.slice(0,5)," - ",s.end_time.slice(0,5)]})]}),s.room_number&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(r,{className:"h-4 w-4 text-primary-400"}),e.jsx("span",{className:"font-medium",children:s.room_number})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>D(s.subject_code,"present"),className:u("flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all",a?"bg-green-500 text-white shadow-lg shadow-green-200 scale-[1.02]":"bg-slate-100 text-slate-500 hover:bg-green-50 hover:text-green-600"),children:[e.jsx(d,{className:"h-5 w-5"}),"Present"]}),e.jsxs("button",{onClick:()=>D(s.subject_code,"absent"),className:u("flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all",l?"bg-red-500 text-white shadow-lg shadow-red-200 scale-[1.02]":"bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-600"),children:[e.jsx(i,{className:"h-5 w-5"}),"Absent"]})]})]},s.id)})})]}):e.jsx("div",{className:"space-y-4",children:0===y.length?e.jsx("div",{className:"text-center py-10 text-slate-400",children:e.jsx("p",{children:"No attendance data recorded yet."})}):y.map(s=>e.jsxs("div",{className:"glass-card p-5 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-800",children:s.subject_name}),e.jsx("p",{className:"text-xs text-slate-500 font-medium",children:s.subject_code})]}),e.jsxs("div",{className:u("text-lg font-bold",s.percentage>=75?"text-green-600":"text-red-600"),children:[s.percentage,"%"]})]}),e.jsx("div",{className:"h-2 w-full bg-slate-100 rounded-full overflow-hidden mb-4",children:e.jsx("div",{className:u("h-full rounded-full transition-all duration-500",s.percentage>=75?"bg-green-500":"bg-red-500"),style:{width:`${s.percentage}%`}})}),e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"Present"}),e.jsx("span",{className:"font-bold text-green-600",children:s.present})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"Absent"}),e.jsx("span",{className:"font-bold text-red-600",children:s.absent})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"Total"}),e.jsx("span",{className:"font-bold text-slate-700",children:s.total_classes})]})]}),s.percentage<75&&e.jsxs("div",{className:"flex items-center gap-1 text-xs font-medium text-amber-600 bg-amber-50 px-2 py-1 rounded-lg",children:[e.jsx(o,{className:"h-3 w-3"}),"Low Attendance"]})]})]},s.subject_code))})]})}export{j as Attendance};
