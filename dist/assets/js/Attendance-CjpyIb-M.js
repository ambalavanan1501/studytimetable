import{j as e,K as t,N as s,O as a,Q as l,c as n,d as r,V as d,X as i,W as c}from"./ui-vendor-BLIzfsG8.js";import{r as o}from"./react-vendor-DR97ylRc.js";import{u as x,c as m,s as h}from"./index-DrLrQOgi.js";import{getDayOrder as u,setDayOrder as p}from"./dayOrder-Bfid7LcI.js";import"./pdf-vendor-D0-bFhii.js";import"./supabase-vendor-C9Ts7tiD.js";function b(){const{user:b}=x(),[g,j]=o.useState("mark"),[f,v]=o.useState(new Date),[w,N]=o.useState([]),[_,y]=o.useState([]),[k,S]=o.useState([]),[q,C]=o.useState(null),[D,A]=o.useState(75),M=e=>e.toISOString().split("T")[0],O=e=>e.toLocaleDateString("en-US",{weekday:"long"}),P=async()=>{if(b)try{if("mark"===g){const e=O(f),t=M(f),s=u(t);C(s);const a=s||e,[l,n]=await Promise.all([h.from("timetable_entries").select("*").eq("user_id",b.id).eq("day",a),h.from("smart_timetable_entries").select("*").eq("user_id",b.id).eq("day",a)]),r=[...l.data||[],...n.data||[]];r.sort((e,t)=>e.start_time.localeCompare(t.start_time)),N(r);const{data:d}=await h.from("attendance_logs").select("subject_code, status").eq("user_id",b.id).eq("date",t);y(d||[]),y(d||[]);const{data:i}=await h.from("profiles").select("attendance_goal").eq("id",b.id).single();(null==i?void 0:i.attendance_goal)&&A(i.attendance_goal)}else{const[e,t]=await Promise.all([h.from("timetable_entries").select("subject_name, subject_code").eq("user_id",b.id),h.from("smart_timetable_entries").select("subject_name, subject_code").eq("user_id",b.id)]),s=new Map;[...e.data||[],...t.data||[]].forEach(e=>{s.has(e.subject_code)||s.set(e.subject_code,e.subject_name)});const{data:a}=await h.from("profiles").select("attendance_goal").eq("id",b.id).single();(null==a?void 0:a.attendance_goal)&&A(a.attendance_goal);const{data:l}=await h.from("attendance_logs").select("subject_code, status").eq("user_id",b.id),n=[];s.forEach((e,t)=>{const s=(null==l?void 0:l.filter(e=>e.subject_code===t))||[],a=s.filter(e=>"present"===e.status).length,r=s.filter(e=>"absent"===e.status).length,d=a+r;n.push({subject_name:e,subject_code:t,total_classes:d,present:a,absent:r,percentage:d>0?Math.round(a/d*100):0})}),S(n)}}catch(e){}};o.useEffect(()=>{P()},[f,b,g]);const T=async(e,t)=>{if(!b)return;const s=M(f);y(s=>[...s.filter(t=>t.subject_code!==e),{subject_code:e,status:t}]);try{const{error:a}=await h.from("attendance_logs").upsert({user_id:b.id,date:s,subject_code:e,status:t},{onConflict:"user_id, date, subject_code"});if(a)throw a}catch(a){P()}},E=e=>{const t=new Date(f);t.setDate(f.getDate()+e),v(t)},L="Saturday"===O(f)||null!==q;return e.jsxs("div",{className:"p-2 md:p-6 space-y-8 pb-32 animate-fade-in-up md:px-4",children:[e.jsxs("div",{className:"flex flex-col gap-2 mt-4 ml-2",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-semibold text-slate-900 tracking-tighter leading-none",children:"Attendance"}),e.jsx("p",{className:"text-lg text-slate-500 font-medium font-display tracking-wide",children:"Stay present, stay ahead."})]}),e.jsx("div",{className:"flex justify-center sticky top-4 z-40",children:e.jsxs("div",{className:"glass-vision p-1.5 rounded-full flex gap-1 shadow-2xl backdrop-blur-3xl border border-white/60",children:[e.jsxs("button",{onClick:()=>j("mark"),className:m("px-6 py-2 rounded-full text-xs font-bold transition-all duration-300 flex items-center gap-2","mark"===g?"bg-slate-900 text-white shadow-lg scale-105":"text-slate-500 hover:text-slate-900 hover:bg-white/40"),children:[e.jsx(t,{className:"h-4 w-4"}),"Mark"]}),e.jsxs("button",{onClick:()=>j("stats"),className:m("px-6 py-2 rounded-full text-xs font-bold transition-all duration-300 flex items-center gap-2","stats"===g?"bg-slate-900 text-white shadow-lg scale-105":"text-slate-500 hover:text-slate-900 hover:bg-white/40"),children:[e.jsx(s,{className:"h-4 w-4"}),"Stats"]})]})}),"mark"===g?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"glass-vision p-4 rounded-[2rem] flex items-center justify-between shadow-xl",children:[e.jsx("button",{onClick:()=>E(-1),className:"p-4 hover:bg-white/50 text-slate-400 hover:text-slate-900 rounded-2xl transition-all",children:e.jsx(a,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-xs font-bold uppercase tracking-[0.2em] text-slate-400 mb-1",children:O(f)}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-3xl font-bold text-slate-900 tracking-tighter tabular-nums",children:f.toLocaleDateString(void 0,{day:"numeric"})}),e.jsx("span",{className:"text-xl font-medium text-slate-500",children:f.toLocaleDateString(void 0,{month:"long"})})]})]}),e.jsx("button",{onClick:()=>E(1),className:"p-4 hover:bg-white/50 text-slate-400 hover:text-slate-900 rounded-2xl transition-all",children:e.jsx(l,{className:"h-6 w-6"})})]}),L&&e.jsx("div",{className:"flex justify-center mb-6 animate-fade-in-up",children:e.jsxs("div",{className:"glass-vision p-2 rounded-2xl flex flex-col items-center gap-2 border border-indigo-100/50",children:[e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-widest text-indigo-400",children:"Day Order"}),e.jsx("div",{className:"flex flex-wrap justify-center gap-2",children:["Monday","Tuesday","Wednesday","Thursday","Friday"].map(t=>e.jsx("button",{onClick:()=>(e=>{const t=M(f);e&&p(t,e),P()})(t),className:m("px-4 py-2 rounded-xl text-xs font-bold transition-all",q===t||!q&&O(f)===t?"bg-indigo-500 text-white shadow-lg shadow-indigo-500/30":"bg-white/40 text-slate-500 hover:bg-white/80"),children:t.slice(0,3)},t))})]})}),e.jsx("div",{className:"space-y-6",children:0===w.length?e.jsxs("div",{className:"text-center py-20 px-6 glass-vision rounded-[3rem] border-2 border-dashed border-white/30",children:[e.jsx("div",{className:"w-20 h-20 bg-slate-100 rounded-[2rem] flex items-center justify-center mx-auto mb-6 text-slate-300 animate-float",children:e.jsx(n,{className:"h-10 w-10"})}),e.jsx("p",{className:"text-2xl font-bold text-slate-300 tracking-tight",children:"No classes scheduled"})]}):w.map(t=>{const s=_.find(e=>e.subject_code===t.subject_code),a="present"===(null==s?void 0:s.status),l="absent"===(null==s?void 0:s.status);return e.jsxs("div",{className:"glass-vision p-5 rounded-[1.5rem] group hover:bg-white/60 transition-all duration-300",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between md:items-start mb-6 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:"glass-panel px-3 py-1 rounded-lg text-[10px] font-black text-slate-500 uppercase tracking-widest",children:t.subject_code}),e.jsx("span",{className:m("text-[10px] px-3 py-1 rounded-lg font-black uppercase tracking-widest","theory"===t.type?"bg-indigo-100 text-indigo-700":"bg-pink-100 text-pink-700"),children:t.type})]}),e.jsx("h3",{className:"font-bold text-2xl text-slate-900 tracking-tight leading-none",children:t.subject_name})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm font-bold text-slate-500 bg-white/40 px-4 py-2 rounded-xl self-start",children:[e.jsx(r,{className:"h-4 w-4"}),t.start_time.slice(0,5)," - ",t.end_time.slice(0,5)]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:()=>T(t.subject_code,"present"),className:m("flex items-center justify-center gap-3 py-4 rounded-[1.5rem] font-bold transition-all duration-300 relative overflow-hidden group/btn",a?"bg-emerald-500 text-white shadow-xl shadow-emerald-500/30 scale-[1.02]":"bg-white/50 text-slate-400 hover:bg-emerald-100 hover:text-emerald-600"),children:[e.jsx(d,{className:"h-5 w-5 stroke-[3px]"}),e.jsx("span",{children:"Present"}),a&&e.jsx("div",{className:"absolute inset-0 bg-white/20 animate-pulse"})]}),e.jsxs("button",{onClick:()=>T(t.subject_code,"absent"),className:m("flex items-center justify-center gap-3 py-4 rounded-[1.5rem] font-bold transition-all duration-300 relative overflow-hidden group/btn",l?"bg-red-500 text-white shadow-xl shadow-red-500/30 scale-[1.02]":"bg-white/50 text-slate-400 hover:bg-red-100 hover:text-red-600"),children:[e.jsx(i,{className:"h-5 w-5 stroke-[3px]"}),e.jsx("span",{children:"Absent"}),l&&e.jsx("div",{className:"absolute inset-0 bg-white/20 animate-pulse"})]})]})]},t.id)})})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:0===k.length?e.jsxs("div",{className:"col-span-full text-center py-20 text-slate-400 glass-vision rounded-[3rem]",children:[e.jsx("p",{className:"text-xl font-bold",children:"No attendance data yet"}),e.jsx("p",{className:"text-sm mt-2 opacity-60",children:"Start marking your classes to see stats!"})]}):k.map(t=>{const s=t.percentage>=D?"bg-emerald-500":"bg-red-500";return e.jsxs("div",{className:"glass-vision p-5 rounded-[1.5rem] hover:scale-[1.02] transition-all duration-500 group relative overflow-hidden",children:[t.percentage<D&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-red-50 to-transparent opacity-50 pointer-events-none"}),e.jsxs("div",{className:"relative z-10 flex justify-between items-start mb-6",children:[e.jsxs("div",{className:"flex-1 pr-4",children:[e.jsx("h3",{className:"font-bold text-slate-900 text-xl leading-tight mb-2 line-clamp-1",title:t.subject_name,children:t.subject_name}),e.jsx("span",{className:"glass-panel px-2 py-1 rounded text-[10px] font-black text-slate-400 uppercase tracking-widest",children:t.subject_code})]}),e.jsxs("div",{className:m("min-w-[4rem] h-[4rem] rounded-[1.5rem] flex items-center justify-center text-xl font-black shadow-lg",t.percentage>=D?"bg-emerald-100 text-emerald-600":"bg-red-100 text-red-600"),children:[t.percentage,e.jsx("span",{className:"text-xs ml-0.5",children:"%"})]})]}),e.jsx("div",{className:"h-4 w-full bg-slate-100/50 rounded-full overflow-hidden mb-6 ring-1 ring-white/50",children:e.jsx("div",{className:m("h-full rounded-full transition-all duration-1000 ease-out shadow-sm",s),style:{width:`${t.percentage}%`}})}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-center",children:[e.jsxs("div",{className:"bg-white/40 rounded-2xl p-3 border border-white/60",children:[e.jsx("div",{className:"text-[10px] uppercase font-bold text-slate-400 mb-1",children:"Present"}),e.jsx("div",{className:"text-xl font-black text-emerald-600",children:t.present})]}),e.jsxs("div",{className:"bg-white/40 rounded-2xl p-3 border border-white/60",children:[e.jsx("div",{className:"text-[10px] uppercase font-bold text-slate-400 mb-1",children:"Absent"}),e.jsx("div",{className:"text-xl font-black text-red-600",children:t.absent})]}),e.jsxs("div",{className:"bg-white/40 rounded-2xl p-3 border border-white/60",children:[e.jsx("div",{className:"text-[10px] uppercase font-bold text-slate-400 mb-1",children:"Total"}),e.jsx("div",{className:"text-xl font-black text-slate-700",children:t.total_classes})]})]}),t.percentage<D&&e.jsxs("div",{className:"mt-6 flex items-center gap-3 text-xs font-bold text-red-600 bg-red-100/50 px-4 py-3 rounded-xl border border-red-100/50",children:[e.jsx(c,{className:"h-4 w-4"}),e.jsx("span",{children:"Attendance Critical"})]})]},t.subject_code)})})]})}export{b as Attendance};
