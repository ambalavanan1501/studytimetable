import{j as e,O as t,Q as s,V as a,W as l,d as r,k as d,Y as n,X as c}from"./ui-vendor-DKQiA0eN.js";import{r as i}from"./react-vendor-UBAF-OWM.js";import{u as o,c as x,s as m}from"./index-Ci4fGroD.js";import{getDayOrder as u,setDayOrder as b}from"./dayOrder-Bfid7LcI.js";import"./pdf-vendor-0-8C3xHX.js";import"./supabase-vendor-B9h0k0q2.js";function h(){const{user:h}=o(),[p,j]=i.useState("mark"),[f,g]=i.useState(new Date),[N,v]=i.useState([]),[w,_]=i.useState([]),[y,k]=i.useState([]),[S,q]=i.useState(null),[C,D]=i.useState(75),M=e=>e.toISOString().split("T")[0],O=e=>e.toLocaleDateString("en-US",{weekday:"long"}),P=async()=>{if(h)try{if("mark"===p){const e=O(f),t=M(f),s=u(t);q(s);const a=s||e,[l,r]=await Promise.all([m.from("timetable_entries").select("*").eq("user_id",h.id).eq("day",a),m.from("smart_timetable_entries").select("*").eq("user_id",h.id).eq("day",a)]),d=[...l.data||[],...r.data||[]];d.sort((e,t)=>e.start_time.localeCompare(t.start_time)),v(d);const{data:n}=await m.from("attendance_logs").select("subject_code, status").eq("user_id",h.id).eq("date",t);_(n||[]),_(n||[]);const{data:c}=await m.from("profiles").select("attendance_goal").eq("id",h.id).single();(null==c?void 0:c.attendance_goal)&&D(c.attendance_goal)}else{const[e,t]=await Promise.all([m.from("timetable_entries").select("subject_name, subject_code").eq("user_id",h.id),m.from("smart_timetable_entries").select("subject_name, subject_code").eq("user_id",h.id)]),s=new Map;[...e.data||[],...t.data||[]].forEach(e=>{s.has(e.subject_code)||s.set(e.subject_code,e.subject_name)});const{data:a}=await m.from("profiles").select("attendance_goal").eq("id",h.id).single();(null==a?void 0:a.attendance_goal)&&D(a.attendance_goal);const{data:l}=await m.from("attendance_logs").select("subject_code, status").eq("user_id",h.id),r=[];s.forEach((e,t)=>{const s=(null==l?void 0:l.filter(e=>e.subject_code===t))||[],a=s.filter(e=>"present"===e.status).length,d=s.filter(e=>"absent"===e.status).length,n=a+d;r.push({subject_name:e,subject_code:t,total_classes:n,present:a,absent:d,percentage:n>0?Math.round(a/n*100):0})}),k(r)}}catch(e){}};i.useEffect(()=>{P()},[f,h,p]);const T=async(e,t)=>{if(!h)return;const s=M(f);_(s=>[...s.filter(t=>t.subject_code!==e),{subject_code:e,status:t}]);try{const{error:a}=await m.from("attendance_logs").upsert({user_id:h.id,date:s,subject_code:e,status:t},{onConflict:"user_id, date, subject_code"});if(a)throw a}catch(a){P()}},A=e=>{const t=new Date(f);t.setDate(f.getDate()+e),g(t)},E="Saturday"===O(f)||null!==S;return e.jsxs("div",{className:"p-2 md:p-6 space-y-8 pb-32 animate-fade-in-up md:px-4",children:[e.jsxs("div",{className:"flex flex-col gap-2 mt-4 ml-2",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-semibold text-slate-900 tracking-tighter leading-none",children:"Attendance"}),e.jsx("p",{className:"text-lg text-slate-500 font-medium font-display tracking-wide",children:"Stay present, stay ahead."})]}),e.jsx("div",{className:"flex justify-center sticky top-4 z-40",children:e.jsxs("div",{className:"bg-white/80 p-1 rounded-full flex gap-1 shadow-sm border border-slate-200/50 backdrop-blur-md",children:[e.jsxs("button",{onClick:()=>j("mark"),className:x("px-6 py-2 rounded-full text-xs font-bold transition-all duration-300 flex items-center gap-2","mark"===p?"bg-slate-900 text-white shadow":"text-slate-400 hover:text-slate-900 hover:bg-slate-100"),children:[e.jsx(t,{className:"h-4 w-4"}),"Mark"]}),e.jsxs("button",{onClick:()=>j("stats"),className:x("px-6 py-2 rounded-full text-xs font-bold transition-all duration-300 flex items-center gap-2","stats"===p?"bg-slate-900 text-white shadow":"text-slate-400 hover:text-slate-900 hover:bg-slate-100"),children:[e.jsx(s,{className:"h-4 w-4"}),"Stats"]})]})}),"mark"===p?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-base p-4 rounded-[1.5rem] flex items-center justify-between shadow-sm border border-slate-100",children:[e.jsx("button",{onClick:()=>A(-1),className:"p-3 hover:bg-slate-100 text-slate-400 hover:text-slate-900 rounded-xl transition-all",children:e.jsx(a,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400 mb-1",children:O(f)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl font-black text-slate-900 tracking-tighter tabular-nums",children:f.toLocaleDateString(void 0,{day:"numeric"})}),e.jsx("span",{className:"text-xl font-medium text-slate-500",children:f.toLocaleDateString(void 0,{month:"long"})})]})]}),e.jsx("button",{onClick:()=>A(1),className:"p-3 hover:bg-slate-100 text-slate-400 hover:text-slate-900 rounded-xl transition-all",children:e.jsx(l,{className:"h-5 w-5"})})]}),E&&e.jsx("div",{className:"flex justify-center mb-6 animate-fade-in-up",children:e.jsxs("div",{className:"bg-white p-2 rounded-2xl flex flex-col items-center gap-2 border border-slate-100 shadow-sm",children:[e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-widest text-slate-400",children:"Day Order"}),e.jsx("div",{className:"flex flex-wrap justify-center gap-2",children:["Monday","Tuesday","Wednesday","Thursday","Friday"].map(t=>e.jsx("button",{onClick:()=>(e=>{const t=M(f);e&&b(t,e),P()})(t),className:x("px-3 py-1.5 rounded-lg text-xs font-bold transition-all",S===t||!S&&O(f)===t?"bg-slate-900 text-white":"bg-slate-50 text-slate-500 hover:bg-slate-100"),children:t.slice(0,3)},t))})]})}),e.jsx("div",{className:"space-y-4",children:0===N.length?e.jsxs("div",{className:"text-center py-20 px-6 card-base rounded-[2rem] border-dashed border-slate-200",children:[e.jsx("div",{className:"w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300",children:e.jsx(r,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-lg font-bold text-slate-300 text-center",children:"No classes scheduled"})]}):N.map(t=>{const s=w.find(e=>e.subject_code===t.subject_code),a="present"===(null==s?void 0:s.status),l="absent"===(null==s?void 0:s.status);return e.jsxs("div",{className:"card-base p-6 rounded-[1.5rem] group hover:border-slate-300 transition-all duration-300",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-1",children:[e.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:t.subject_code}),e.jsx("span",{className:x("w-1.5 h-1.5 rounded-full","theory"===t.type?"bg-indigo-500":"bg-pink-500")})]}),e.jsx("h3",{className:"font-bold text-xl text-slate-900 tracking-tight",children:t.subject_name})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs font-bold text-slate-500 bg-slate-50 px-3 py-1.5 rounded-lg self-start md:self-center",children:[e.jsx(d,{className:"h-3 w-3"}),t.start_time.slice(0,5)," - ",t.end_time.slice(0,5)]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>T(t.subject_code,"present"),className:x("flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all duration-300 border-2",a?"bg-emerald-50 border-emerald-500 text-emerald-700":"bg-white border-slate-100 text-slate-400 hover:border-emerald-200 hover:text-emerald-600"),children:[a?e.jsx(n,{className:"h-4 w-4"}):e.jsx("div",{className:"w-4 h-4 rounded-full border-2 border-slate-200 group-hover:border-emerald-400"}),e.jsx("span",{children:"Present"})]}),e.jsxs("button",{onClick:()=>T(t.subject_code,"absent"),className:x("flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all duration-300 border-2",l?"bg-red-50 border-red-500 text-red-700":"bg-white border-slate-100 text-slate-400 hover:border-red-200 hover:text-red-600"),children:[l?e.jsx(c,{className:"h-4 w-4"}):e.jsx("div",{className:"w-4 h-4 rounded-full border-2 border-slate-200 group-hover:border-red-400"}),e.jsx("span",{children:"Absent"})]})]})]},t.id)})})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:0===y.length?e.jsxs("div",{className:"col-span-full text-center py-20 text-slate-400 card-base rounded-[2rem] border-dashed border-slate-200",children:[e.jsx("p",{className:"text-xl font-bold",children:"No attendance data yet"}),e.jsx("p",{className:"text-sm mt-2 opacity-60",children:"Start marking your classes to see stats!"})]}):y.map(t=>e.jsxs("div",{className:"card-base p-6 rounded-[1.5rem] hover:shadow-lg transition-all duration-300 flex flex-col justify-between",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex-1 pr-4",children:[e.jsx("h3",{className:"font-bold text-slate-900 text-lg leading-tight line-clamp-1",title:t.subject_name,children:t.subject_name}),e.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:t.subject_code})]}),e.jsxs("div",{className:x("text-xl font-black tabular-nums",t.percentage>=C?"text-emerald-600":"text-red-500"),children:[t.percentage,"%"]})]}),e.jsx("div",{className:"h-2 w-full bg-slate-100 rounded-full overflow-hidden",children:e.jsx("div",{className:x("h-full rounded-full transition-all duration-1000 ease-out",t.percentage>=C?"bg-emerald-500":"bg-red-500"),style:{width:`${t.percentage}%`}})})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs font-bold text-slate-500 border-t border-slate-50 pt-4",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-emerald-600",children:t.present}),e.jsx("span",{className:"text-[9px] uppercase tracking-widest text-slate-300",children:"Pres"})]}),e.jsx("div",{className:"w-px h-4 bg-slate-100"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-red-500",children:t.absent}),e.jsx("span",{className:"text-[9px] uppercase tracking-widest text-slate-300",children:"Abs"})]}),e.jsx("div",{className:"w-px h-4 bg-slate-100"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-slate-700",children:t.total_classes}),e.jsx("span",{className:"text-[9px] uppercase tracking-widest text-slate-300",children:"Tot"})]})]})]},t.subject_code))})]})}export{h as Attendance};
